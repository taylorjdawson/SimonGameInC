//------------------------------------------------------------------------------
//             __             __   ___  __
//     | |\ | /  ` |    |  | |  \ |__  /__`
//     | | \| \__, |___ \__/ |__/ |___ .__/
//
//------------------------------------------------------------------------------

#include "led.h"
#include "spi.h"

//------------------------------------------------------------------------------
//      __   ___  ___         ___  __
//     |  \ |__  |__  | |\ | |__  /__`
//     |__/ |___ |    | | \| |___ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//     ___      __   ___  __   ___  ___  __
//      |  \ / |__) |__  |  \ |__  |__  /__`
//      |   |  |    |___ |__/ |___ |    .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//                __          __        ___  __
//     \  /  /\  |__) |  /\  |__) |    |__  /__`
//      \/  /~~\ |  \ | /~~\ |__) |___ |___ .__/
//
//------------------------------------------------------------------------------
static uint16_t led_values[16];
static uint8_t data[24];
//------------------------------------------------------------------------------
//      __   __   __  ___  __  ___      __   ___  __
//     |__) |__) /  \  |  /  \  |  \ / |__) |__  /__`
//     |    |  \ \__/  |  \__/  |   |  |    |___ .__/
//
//------------------------------------------------------------------------------
static void bit_conversion(uint16_t* array, uint8_t* data_array);
//------------------------------------------------------------------------------
//      __        __          __
//     |__) |  | |__) |    | /  `
//     |    \__/ |__) |___ | \__,
//
//------------------------------------------------------------------------------

void rgb(uint8_t light_select, uint8_t red, uint8_t green, uint8_t blue)
{
	red_set(red);
	green_set(green);
	blue_set(blue);
	bit_conversion(led_values, data);
	spi_write(data);
}

//==============================================================================
void red_set(uint8_t light_select, uint8_t led_value)
{
	led_values[light_select*3-3] = led_value * 16;
	bit_conversion(led_values, data);
	spi_write(data);
}

//==============================================================================
void green_set(uint8_t light_select, uint8_t led_value)
{
	led_values[light_select*3-2] = led_value * 16;
	bit_conversion(led_values, data);
	spi_write(data);
}

//==============================================================================
void blue_set(uint8_t light_select, uint8_t led_value)
{
	led_values[light_select*3-1] = led_value * 16;
	bit_conversion(led_values, data);
	spi_write(data);
}


//------------------------------------------------------------------------------
//      __   __              ___  ___
//     |__) |__) | \  /  /\   |  |__
//     |    |  \ |  \/  /~~\  |  |___
//
//------------------------------------------------------------------------------

//==============================================================================
static void bit_conversion(uint16_t* array, uint8_t* data_array)
{
	uint8_t ind = 0;
	
	for (int i = 8; i > 0; i--)
	{
		data_array[ind++] = (array[i * 2 - 1] & 0x0FF0) >> 4;
		data_array[ind++] = ((array[i * 2 - 1] & 0x000F) << 4) | ((array[i * 2 - 2] & 0x0F00) >> 8);
		data_array[ind++] = array[i * 2 - 2] & 0x00FF;
	}
}

//==============================================================================
static inline clear_led_values()
{
	for( int i = 0; i < 16; i++)
	{
		led_values[i] = 0;
	}
}
//------------------------------------------------------------------------------
//      __                  __        __        __
//     /  `  /\  |    |    |__)  /\  /  ` |__/ /__`
//     \__, /~~\ |___ |___ |__) /~~\ \__, |  \ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//        __   __  , __
//     | /__` |__)  /__`   
//     | .__/ |  \  .__/
//
//------------------------------------------------------------------------------
